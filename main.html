<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DataLens - File Data Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; }
    .table-responsive { max-height: 60vh; overflow-y: auto; }
    th { cursor: pointer; position: sticky; top: 0; background: var(--bs-body-bg); }
    th.sort-asc::after { content: " ⬆"; }
    th.sort-desc::after { content: " ⬇"; }
    .dark-mode { background: #121212; color: #e0e0e0; }
    .dark-mode .table { color: #e0e0e0; }
    .hover-highlight tbody tr:hover { background-color: rgba(0,123,255,.1); transition: background-color .2s; }
    .chart-container { height: 400px; }
  </style>
</head>
<body class="p-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>📊 DataLens</h3>
    <button id="darkModeToggle" class="btn btn-sm btn-outline-secondary">🌙 Toggle Dark/Light</button>
  </div>

  <!-- File Upload Section -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <select id="fileType" class="form-select">
            <option value="auto">Auto Detect</option>
            <option value="csv">CSV</option>
            <option value="excel">Excel</option>
            <option value="json">JSON</option>
            <option value="txt">Text</option>
            <option value="xml">XML</option>
          </select>
        </div>
        <div class="col-md-9">
          <input type="file" id="fileInput" class="form-control" />
        </div>
      </div>
    </div>
  </div>

  <!-- File Info -->
  <div id="fileInfo" class="alert alert-info d-none"></div>

  <!-- Controls -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <input id="globalSearch" class="form-control w-auto" placeholder="🔍 Search..." />
    <select id="rowsPerPage" class="form-select w-auto">
      <option>10</option><option>20</option><option>50</option><option>100</option>
    </select>
    <button id="resetView" class="btn btn-outline-secondary btn-sm">Reset View</button>
    <button id="clearData" class="btn btn-outline-danger btn-sm">Clear Data</button>
    <button id="exportCSV" class="btn btn-outline-success btn-sm">Export CSV</button>
    <button id="exportXLSX" class="btn btn-outline-primary btn-sm">Export Excel</button>
  </div>

  <!-- Data Table -->
  <div class="table-responsive">
    <table id="dataTable" class="table table-striped table-bordered hover-highlight">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav><ul id="pagination" class="pagination mt-2"></ul></nav>

  <!-- Chart Section -->
  <div class="card mt-3">
    <div class="card-body">
      <h5>📈 Visualization</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <select id="categoryColumn" class="form-select"><option disabled selected>Select Category</option></select>
        </div>
        <div class="col-md-4">
          <select id="numericColumn" class="form-select"><option disabled selected>Select Numeric</option></select>
        </div>
        <div class="col-md-4">
          <select id="chartType" class="form-select">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="pie">Pie</option>
          </select>
        </div>
      </div>
      <button id="generateChart" class="btn btn-primary btn-sm mt-2">Generate Chart</button>
      <div class="chart-container mt-3"><canvas id="chartCanvas"></canvas></div>
    </div>
  </div>

<script>
  let rawData = [];
  let filteredData = [];
  let currentPage = 1;
  let rowsPerPage = 10;
  let currentSort = { col: null, dir: null };
  let chartInstance = null;

  // Utility
  function humanFileSize(size) {
    if (size < 1024) return size + " B";
    let units = ["KB","MB","GB"];
    let i = Math.floor(Math.log(size)/Math.log(1024));
    return (size/Math.pow(1024,i)).toFixed(1)+" "+units[i-1];
  }

  // File Handling
  document.getElementById("fileInput").addEventListener("change", e => handleFile(e.target.files[0]));

  async function handleFile(file) {
    if (!file) return;
    const type = document.getElementById("fileType").value;
    const ext = file.name.split(".").pop().toLowerCase();
    const buffer = await file.arrayBuffer();
    const text = new TextDecoder().decode(buffer);

    if (type === "csv" || (type==="auto" && ext==="csv")) {
      const res = Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true});
      loadData(res.data,file);
    } else if (type==="excel" || (type==="auto" && /(xlsx|xls)$/.test(ext))) {
      const wb = XLSX.read(buffer,{type:"array"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      loadData(XLSX.utils.sheet_to_json(ws),file);
    } else if (type==="json" || (type==="auto" && ext==="json")) {
      loadData(JSON.parse(text),file);
    } else if (type==="txt" || (type==="auto" && ext==="txt")) {
      const rows=text.split(/\r?\n/).map(r=>r.split(/\s+|,|;/));
      const headers=rows.shift();
      loadData(rows.map(r=>Object.fromEntries(headers.map((h,i)=>[h,r[i]]))),file);
    } else if (type==="xml" || (type==="auto" && ext==="xml")) {
      const xml=new DOMParser().parseFromString(text,"application/xml");
      const rows=[...xml.getElementsByTagName("row")];
      const objArr=rows.map(r=>{
        let obj={};[...r.children].forEach(c=>obj[c.tagName]=c.textContent);return obj;
      });
      loadData(objArr,file);
    } else {
      alert("Unsupported file format");
    }
  }

  function loadData(data,file){
    rawData=data.filter(row=>Object.keys(row).length);
    filteredData=[...rawData];
    sessionStorage.setItem("datalens",JSON.stringify(rawData));
    document.getElementById("fileInfo").classList.remove("d-none");
    document.getElementById("fileInfo").textContent=
      `${file.name} (${humanFileSize(file.size)}), Rows: ${rawData.length}, Cols: ${Object.keys(rawData[0]||{}).length}`;
    renderTable();
    populateChartOptions();
  }

  // Table Rendering
  function renderTable() {
    const thead=document.querySelector("#dataTable thead");
    const tbody=document.querySelector("#dataTable tbody");
    thead.innerHTML="";tbody.innerHTML="";
    if(!filteredData.length) return;
    const headers=Object.keys(filteredData[0]);
    const tr=document.createElement("tr");
    headers.forEach((h,i)=>{
      const th=document.createElement("th");
      th.textContent=h;
      th.onclick=()=>sortColumn(h);
      if(currentSort.col===h) th.classList.add(currentSort.dir==="asc"?"sort-asc":"sort-desc");
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    const start=(currentPage-1)*rowsPerPage;
    const pageData=filteredData.slice(start,start+rowsPerPage);
    pageData.forEach(row=>{
      const tr=document.createElement("tr");
      headers.forEach(h=>{
        const td=document.createElement("td");
        td.textContent=row[h]??"";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    renderPagination();
  }

  function renderPagination() {
    const pag=document.getElementById("pagination");pag.innerHTML="";
    const totalPages=Math.ceil(filteredData.length/rowsPerPage);
    for(let i=1;i<=totalPages;i++){
      const li=document.createElement("li");
      li.className="page-item "+(i===currentPage?"active":"");
      li.innerHTML=`<a class="page-link" href="#">${i}</a>`;
      li.onclick=e=>{e.preventDefault();currentPage=i;renderTable();};
      pag.appendChild(li);
    }
  }

  function sortColumn(key){
    if(currentSort.col===key){
      currentSort.dir=currentSort.dir==="asc"?"desc":"asc";
    } else {
      currentSort={col:key,dir:"asc"};
    }
    filteredData.sort((a,b)=>{
      if(a[key]<b[key]) return currentSort.dir==="asc"?-1:1;
      if(a[key]>b[key]) return currentSort.dir==="asc"?1:-1;
      return 0;
    });
    renderTable();
  }

  // Search
  document.getElementById("globalSearch").addEventListener("input",e=>{
    const term=e.target.value.toLowerCase();
    filteredData=rawData.filter(r=>Object.values(r).join(" ").toLowerCase().includes(term));
    currentPage=1;renderTable();
  });

  document.getElementById("rowsPerPage").addEventListener("change",e=>{
    rowsPerPage=parseInt(e.target.value);currentPage=1;renderTable();
  });

  document.getElementById("resetView").onclick=()=>{filteredData=[...rawData];currentSort={};currentPage=1;renderTable();};
  document.getElementById("clearData").onclick=()=>{sessionStorage.removeItem("datalens");rawData=[];filteredData=[];document.querySelector("#dataTable thead").innerHTML="";document.querySelector("#dataTable tbody").innerHTML="";};

  document.getElementById("exportCSV").onclick=()=>{
    const csv=Papa.unparse(filteredData);
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="export.csv";a.click();
  };
  document.getElementById("exportXLSX").onclick=()=>{
    const ws=XLSX.utils.json_to_sheet(filteredData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Data");
    XLSX.writeFile(wb,"export.xlsx");
  };

  // Dark Mode
  document.getElementById("darkModeToggle").onclick=()=>{
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode",document.body.classList.contains("dark-mode"));
  };
  if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark-mode");

  // Chart Section
  function populateChartOptions(){
    const headers=Object.keys(rawData[0]||{});
    const catSel=document.getElementById("categoryColumn");
    const numSel=document.getElementById("numericColumn");
    catSel.innerHTML="<option disabled selected>Select Category</option>";
    numSel.innerHTML="<option disabled selected>Select Numeric</option>";
    headers.forEach(h=>{
      catSel.innerHTML+=`<option>${h}</option>`;
      numSel.innerHTML+=`<option>${h}</option>`;
    });
  }

  document.getElementById("generateChart").onclick=()=>{
    const cat=document.getElementById("categoryColumn").value;
    const num=document.getElementById("numericColumn").value;
    const type=document.getElementById("chartType").value;
    if(!cat||!num) return alert("Select both columns");
    let agg={};
    rawData.forEach(r=>{
      const c=r[cat], n=parseFloat(r[num]);
      if(c&&!isNaN(n)) agg[c]=(agg[c]||0)+n;
    });
    const labels=Object.keys(agg);
    const data=Object.values(agg);
    if(chartInstance) chartInstance.destroy();
    chartInstance=new Chart(document.getElementById("chartCanvas"),{
      type:type,
      data:{labels:labels,datasets:[{label:num,data:data,backgroundColor:"rgba(54,162,235,.6)"}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  };
</script>
</body>
</html>
