<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DataLens — No Query Workspace</title>
    <link rel="icon" type="image/png" href="assets/DataLensIco.ico" />

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            /* blue-600 */
            --accent: #0ea5a4;
            /* teal-500 */
            --bg: #f6f8fb;
            --card-radius: 12px;
            --muted: #6b7280;
        }

        html,
        body {
            height: 100%;
            background: var(--bg);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            color: #0f172a;
        }

        /* ==== HEADER ==== */
        .navbar {
            background: linear-gradient(180deg, rgba(184, 236, 201, 0.9), rgba(136, 236, 194, 0.8));
        }

        .navbar-brand {
            font-weight: 700;
            color: #000000 !important;
            font-size: 1.4rem;
        }

        .nav-link {
            color: #000000 !important;
            margin-right: 1rem;
            transition: 0.3s;
        }

        .nav-link:hover {
            color: #facc15 !important;
        }

        /* Layout */
        .app-shell {
            padding: 1.25rem;

        }

        .card {
            border: 0;
            border-radius: var(--card-radius);
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.04);
            background: linear-gradient(180deg, rgba(220, 245, 228, 0.9), rgba(255, 255, 255, 0.82)) !important;
        }

        /* Upload area */
        .uploader {
            min-height: 120px;
            border: 2px dashed rgba(15, 23, 42, 0.06);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.6), transparent);
            position: relative;
            /* important so input absolute fits */
            cursor: pointer;
        }

        .uploader.dragover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.04);
        }

        /* Columns list */
        .columns-checkboxes {
            max-height: 500px;
            overflow: auto;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #eef2f6;
            background: #fff;
        }

        /* Table */
        .table-wrap {
            max-height: 46vh;
            overflow: auto;
            border-radius: 10px;
            border: 1px solid #eef2f6;
            background: #fff;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 2;
        }

        /* Controls */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 999px;
            background: #eef2f7;
            margin-right: 6px;
            font-size: 0.85rem;
        }

        /* Small screen adjustments */
        @media (max-width:991.98px) {
            .sidebar-collapse {
                order: 1;
            }

            .main-collapse {
                order: 1;
            }
        }

        /* Tiny utilities */
        .muted {
            color: var(--muted);
        }

        .text-primary-600 {
            color: var(--primary);
        }

        /* ensure chart container limits height */
        .chart-wrap {
            max-height: 320px;
            height: 320px;
            position: relative;
        }

        /* FOOTER */
        footer {
            background: linear-gradient(180deg, rgba(184, 236, 201, 0.9), rgba(136, 236, 194, 0.8));
            color: #000000;
            padding: 20px 20px;
            text-align: center;
        }

        footer a {
            color: #ff6600;
        }
    </style>
</head>

<body>
    <!-- NAV -->
    <nav class="navbar navbar-expand-lg px-3 py-2">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="assets/DataLensLogo.png" alt="DataLens Logo" height="40">
            <div class="d-flex flex-column">
                <span>DataLens</span>
                <small class="text-muted" style="font-size:10px;">Client-Side Data Platform</small>
            </div>
        </a>
        <div class="ms-auto d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-light" onclick="redirectToPage('index.html')" title="Home">
                <i class="bi bi-house-door"></i>
            </button>
            <button class="btn btn-sm btn-light" id="helpBtn" title="Docs & Help" onclick="redirectToPage('docs.html')">
                <i class="bi bi-question-circle"></i>
            </button>
        </div>
    </nav>

    <main class="container-fluid app-shell">
        <div class="row g-3">

            <!-- SIDEBAR -->
            <aside class="col-12 col-lg-3 sidebar-collapse">
                <div class="card p-3" style="height: -webkit-fill-available;">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">Upload & Source</h6>
                        <small class="text-muted">Max 10 MB</small>
                    </div>

                    <div id="uploader" class="uploader mb-3" tabindex="0" aria-label="File upload drop zone">
                        <div class="text-center p-2">
                            <i class="bi bi-cloud-arrow-up display-6 text-primary-600"></i>
                            <div class="fw-semibold mt-2">Drop file here or click to browse</div>
                            <div class="muted small">CSV · Excel (.xlsx) · JSON</div>
                        </div>
                        <!-- input now covers uploader area so clicks always open file picker -->
                        <input id="fileInput" type="file" accept=".csv,.xlsx,.xls,.json" aria-label="File input"
                            style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;" />
                    </div>

                    <div class="d-flex gap-2 mb-3">
                        <button id="loadBtn" class="btn btn-success flex-grow-1"> <i class="bi bi-arrow-bar-up"></i>
                            Upload</button>
                        <button id="clearDB" class="btn btn-outline-warning" title="Clear stored dataset"><i
                                class="bi bi-x-circle"></i></button>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted">Dataset summary</small>
                        <div class="mt-2 d-flex flex-column gap-2">
                            <div><span id="rowCount" class="chip">0 rows</span> <span id="colCount" class="chip">0
                                    columns</span></div>
                            <div id="schemaSummary" class="small muted">No data loaded</div>
                        </div>
                    </div>

                    <hr />

                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <div class="small fw-semibold">Columns</div>
                        <div>
                            <button id="selectAllCols" class="btn btn-sm btn-link">Select all</button>
                        </div>
                    </div>
                    <div id="columnsContainer" class="columns-checkboxes" aria-live="polite"></div>

                </div>
            </aside>

            <!-- MAIN -->
            <section class="col-12 col-lg-9 main-collapse">
                <div class="card p-3">
                    <div class="d-flex align-items-start justify-content-between mb-3 gap-3 flex-wrap">
                        <div>
                            <h5 class="mb-0">No - Query Workspace</h5>
                            <small class="muted">Build queries visually — no SQL required</small>
                        </div>

                        <div class="d-flex gap-2 align-items-center">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input id="globalSearch" class="form-control form-control-sm"
                                    placeholder="Search in results..." aria-label="Global search" />
                            </div>

                            <div class="dropdown">
                                <button class="btn btn-outline-success btn-sm dropdown-toggle"
                                    data-bs-toggle="dropdown">Export</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" id="exportCSVBtn">CSV</a></li>
                                    <li><a class="dropdown-item" id="exportExcelBtn">Excel</a></li>
                                </ul>
                            </div>

                            <button id="resetQueryBtn" class="btn btn-outline-primary btn-sm" title="Reset"><i
                                    class="bi bi-arrow-counterclockwise"></i></button>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-12 col-lg-4">
                            <label class="form-label small"><i class="bi bi-filter-square"></i> Filters</label>
                            <div id="filterContainer"></div>
                            <div class="mt-2 d-flex gap-2">
                                <button id="addFilterBtn" class="btn btn-sm btn-outline-success"><i
                                        class="bi bi-plus"></i> Add filter</button>
                                <button id="clearFilters" class="btn btn-sm btn-outline-warning">Clear</button>
                            </div>
                        </div>

                        <div class="col-12 col-lg-4">
                            <label class="form-label small"><i class="bi bi-sort-alpha-down"></i> Order</label>
                            <div id="orderContainer"></div>
                            <div class="mt-2">
                                <button id="addOrderBtn" class="btn btn-sm btn-outline-success"><i
                                        class="bi bi-plus"></i> Add order</button>
                            </div>
                        </div>

                        <div class="col-12 col-lg-4">
                            <label class="form-label small"><i class="bi bi-diagram-3"></i> Group & Aggregate</label>
                            <div class="d-flex gap-2">
                                <select id="groupBySelect" class="form-select form-select-sm">
                                    <option value="">(Group by)</option>
                                </select>
                                <select id="aggFuncSelect" class="form-select form-select-sm">
                                    <option value="">(Agg)</option>
                                    <option value="sum">SUM</option>
                                    <option value="avg">AVG</option>
                                    <option value="count">COUNT</option>
                                    <option value="max">MAX</option>
                                    <option value="min">MIN</option>
                                </select>
                                <select id="aggFieldSelect" class="form-select form-select-sm">
                                    <option value="">(Field)</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-12 d-flex gap-2">
                            <button id="runQueryBtn" class="btn btn-success"><i class="bi bi-play-fill"></i>
                                Run</button>
                            <div class="ms-auto d-flex gap-2 align-items-center">
                                <small class="muted">Rows per page</small>
                                <select id="pageSizeSel" class="form-select form-select-sm" style="width:80px">
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RESULTS -->
                <div class="card p-3 mt-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h6 class="mb-0">Query Results</h6>
                            <small class="muted">Rendered from the current query</small>
                        </div>
                        <div class="small muted">Showing <span id="showingCount">0</span> rows • <span id="runtime">0
                                ms</span></div>
                    </div>

                    <div class="table-wrap mb-2">
                        <table class="table table-hover table-bordered table-sm align-middle mb-0" id="dataTable">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <nav>
                            <ul id="pagination" class="pagination mb-0 flex-wrap"></ul>
                        </nav>
                        <div class="ms-auto d-flex gap-2 align-items-center">
                            <button id="downloadViewBtn" class="btn btn-sm btn-outline-success">Download view</button>
                            <button id="copyBtn" class="btn btn-sm btn-outline-success"
                                title="Copy table to clipboard"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </div>

                    <hr />

                    <div>
                        <h6 class="mb-2">Chart Preview</h6>
                        <div class="chart-wrap">
                            <canvas id="chartCanvas"></canvas>
                        </div>
                    </div>

                </div>

            </section>
        </div>
    </main>
    <!-- FOOTER -->
    <footer>
        <p>&copy; 2025 Qbitrix DataLens | Client-Side Data Platform Suite. All rights reserved. @Author <a class=""
                href="https://sachinkumarhebri.vercel.app" target="_blank">Sachin kumar</a></p>
    </footer>


    <!-- SCRIPTS -->
    <script>
        // --- State ---
        let fullData = [];
        let filteredData = [];
        let currentView = [];
        let currentPage = 1;
        let chart = null;

        // Elements
        const fileInput = document.getElementById('fileInput');
        const uploader = document.getElementById('uploader');
        const loadBtn = document.getElementById('loadBtn');
        const rowCount = document.getElementById('rowCount');
        const colCount = document.getElementById('colCount');
        const schemaSummary = document.getElementById('schemaSummary');
        const columnsContainer = document.getElementById('columnsContainer');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const addOrderBtn = document.getElementById('addOrderBtn');
        const runQueryBtn = document.getElementById('runQueryBtn');
        const filterContainer = document.getElementById('filterContainer');
        const orderContainer = document.getElementById('orderContainer');
        const groupBySelect = document.getElementById('groupBySelect');
        const aggFuncSelect = document.getElementById('aggFuncSelect');
        const aggFieldSelect = document.getElementById('aggFieldSelect');
        const dataTable = document.getElementById('dataTable');
        const pagination = document.getElementById('pagination');
        const showingCount = document.getElementById('showingCount');
        const runtimeEl = document.getElementById('runtime');
        const globalSearch = document.getElementById('globalSearch');
        const pageSizeSel = document.getElementById('pageSizeSel');
        const selectAllCols = document.getElementById('selectAllCols');

        const pageSizeDefault = () => parseInt(pageSizeSel.value || '10', 10);

        // --- Helpers ---
        function detectType(values) {
            // Basic detection: number, boolean, date, string
            let num = 0, bool = 0, datec = 0, str = 0, samples = 0;
            for (const v of (values || []).slice(0, 50)) {
                samples++;
                if (v === null || v === undefined || v === '') { continue }
                if (typeof v === 'boolean') { bool++; continue }
                const n = parseFloat(String(v).replace(/,/g, ''));
                if (!isNaN(n) && isFinite(n)) { num++; continue }
                const d = Date.parse(v);
                if (!isNaN(d)) { datec++; continue }
                str++;
            }
            if (samples === 0) return 'string';
            if (num > samples * 0.6) return 'number';
            if (datec > samples * 0.6) return 'date';
            if (bool > samples * 0.6) return 'boolean';
            return 'string';
        }

        function formatNumber(n) { return (n || 0).toLocaleString(); }

        function safeGet(obj, key) { return obj && Object.prototype.hasOwnProperty.call(obj, key) ? obj[key] : null }

        // --- UI building ---
        function populateColumnsUI(cols) {
            columnsContainer.innerHTML = '';
            (cols || []).forEach(c => {
                const id = 'col_' + String(c).replace(/\W/g, '_');
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `<input class="form-check-input" type="checkbox" id="${id}" value="${c}" checked>
                         <label class="form-check-label" for="${id}">${c}</label>`;
                columnsContainer.appendChild(div);
            });

            groupBySelect.innerHTML = '<option value="">(Group by)</option>';
            aggFieldSelect.innerHTML = '<option value="">(Field)</option>';
            (cols || []).forEach(c => {
                groupBySelect.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`);
                aggFieldSelect.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`);
            });
        }

        function getSelectedColumns() {
            return Array.from(columnsContainer.querySelectorAll('input[type=checkbox]:checked')).map(i => i.value);
        }

        selectAllCols.onclick = () => {
            const chks = columnsContainer.querySelectorAll('input[type=checkbox]');
            chks.forEach(c => c.checked = true);
        };

        // --- Filters & Orders ---
        function addFilterRow(fieldOptions = []) {
            const row = document.createElement('div');
            row.className = 'row g-2 align-items-center mb-2 filter-row';
            row.innerHTML = `
        <div class="col-5">
          <select class="form-select form-select-sm filterField"><option value="">(Field)</option></select>
        </div>
        <div class="col-3">
          <select class="form-select form-select-sm filterOp">
            <option value="=">=</option>
            <option value="!=">!=</option>
            <option value=">">&gt;</option>
            <option value="<">&lt;</option>
            <option value=">=">&gt;=</option>
            <option value="<=">&lt;=</option>
            <option value="contains">contains</option>
          </select>
        </div>
        <div class="col-3">
          <input class="form-control form-control-sm filterValue" placeholder="Value">
        </div>
        <div class="col-1 text-end">
          <button class="btn btn-sm btn-outline-danger removeFilterBtn" title="Remove"><i class="bi bi-trash"></i></button>
        </div>`;
            filterContainer.appendChild(row);
            const sel = row.querySelector('.filterField');
            (fieldOptions || []).forEach(f => sel.insertAdjacentHTML('beforeend', `<option value="${f}">${f}</option>`));
            row.querySelector('.removeFilterBtn').onclick = () => row.remove();
        }

        function addOrderRule(fieldOptions = []) {
            const el = document.createElement('div');
            el.className = 'row g-2 align-items-center mb-2 order-row';
            el.innerHTML = `
        <div class="col-7"><select class="form-select form-select-sm orderField"><option value="">(Field)</option></select></div>
        <div class="col-3"><select class="form-select form-select-sm orderDir"><option value="asc">Asc</option><option value="desc">Desc</option></select></div>
        <div class="col-2 text-end"><button class="btn btn-sm btn-outline-danger removeOrderBtn"><i class="bi bi-trash"></i></button></div>`;
            orderContainer.appendChild(el);
            const sel = el.querySelector('.orderField');
            (fieldOptions || []).forEach(f => sel.insertAdjacentHTML('beforeend', `<option value="${f}">${f}</option>`));
            el.querySelector('.removeOrderBtn').onclick = () => el.remove();
        }

        addFilterBtn.onclick = () => addFilterRow(Object.keys(fullData[0] || {}));
        addOrderBtn.onclick = () => addOrderRule(Object.keys(fullData[0] || {}));

        // --- Core: apply query ---
        function applyQuery() {
            const t0 = performance.now();
            let data = Array.isArray(fullData) ? [...fullData] : [];

            // WHERE filters
            Array.from(filterContainer.querySelectorAll('.filter-row')).forEach(row => {
                const field = row.querySelector('.filterField').value;
                const op = row.querySelector('.filterOp').value;
                const val = row.querySelector('.filterValue').value;
                if (!field || val === '') return;
                data = data.filter(r => {
                    const rv = safeGet(r, field);
                    if (rv === null || rv === undefined) return false;
                    const s = String(rv).toLowerCase();
                    const vv = String(val).toLowerCase();
                    switch (op) {
                        case '=': return s === vv;
                        case '!=': return s !== vv;
                        case '>': return parseFloat(String(rv).replace(/,/g, '')) > parseFloat(val);
                        case '<': return parseFloat(String(rv).replace(/,/g, '')) < parseFloat(val);
                        case '>=': return parseFloat(String(rv).replace(/,/g, '')) >= parseFloat(val);
                        case '<=': return parseFloat(String(rv).replace(/,/g, '')) <= parseFloat(val);
                        case 'contains': return s.includes(vv);
                        default: return true;
                    }
                });
            });

            // SELECT columns
            const cols = getSelectedColumns();
            if (cols.length) data = data.map(r => { const o = {}; cols.forEach(c => o[c] = r[c]); return o; });

            // GROUP + AGG
            const groupBy = groupBySelect.value;
            const aggFn = aggFuncSelect.value;
            const aggField = aggFieldSelect.value;
            if (groupBy && aggFn && aggField) {
                const groups = {};
                data.forEach(r => {
                    const k = r[groupBy] == null ? '__NULL__' : String(r[groupBy]);
                    groups[k] = groups[k] || [];
                    groups[k].push(r);
                });
                data = Object.entries(groups).map(([k, arr]) => {
                    const out = {}; out[groupBy] = k === '__NULL__' ? null : k;
                    switch (aggFn) {
                        case 'sum':
                            out[`${aggFn}(${aggField})`] = arr.reduce((a, b) => a + (parseFloat(b[aggField]) || 0), 0);
                            break;
                        case 'avg':
                            out[`${aggFn}(${aggField})`] = arr.reduce((a, b) => a + (parseFloat(b[aggField]) || 0), 0) / arr.length;
                            break;
                        case 'count':
                            out[`${aggFn}(${aggField})`] = arr.length;
                            break;
                        case 'max':
                            out[`${aggFn}(${aggField})`] = Math.max(...arr.map(x => parseFloat(x[aggField]) || -Infinity));
                            break;
                        case 'min':
                            out[`${aggFn}(${aggField})`] = Math.min(...arr.map(x => parseFloat(x[aggField]) || Infinity));
                            break;
                    }
                    return out;
                });
            }

            // ORDER BY
            const orderRules = Array.from(orderContainer.querySelectorAll('.order-row')).map(r => {
                const f = r.querySelector('.orderField')?.value; const d = r.querySelector('.orderDir')?.value || 'asc';
                return f ? { field: f, dir: d } : null;
            }).filter(Boolean);
            if (orderRules.length) {
                data.sort((a, b) => {
                    for (const rule of orderRules) {
                        const fa = a[rule.field]; const fb = b[rule.field];
                        if (fa == null && fb != null) return rule.dir === 'asc' ? -1 : 1;
                        if (fb == null && fa != null) return rule.dir === 'asc' ? 1 : -1;
                        if (fa < fb) return rule.dir === 'asc' ? -1 : 1;
                        if (fa > fb) return rule.dir === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }

            filteredData = data;
            currentView = [...filteredData];
            currentPage = 1;
            renderTable();
            renderChart();
            const t1 = performance.now();
            runtimeEl.textContent = Math.round(t1 - t0) + ' ms';
        }

        runQueryBtn.onclick = applyQuery;

        // --- Render table/pagination/chart ---
        function renderTable() {
            const thead = dataTable.querySelector('thead');
            const tbody = dataTable.querySelector('tbody');
            thead.innerHTML = ''; tbody.innerHTML = '';
            if (!Array.isArray(currentView) || !currentView.length) {
                thead.innerHTML = '<tr><th>No data</th></tr>';
                showingCount.textContent = '0';
                return;
            }
            const cols = Object.keys(currentView[0] || {});
            thead.innerHTML = `<tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr>`;
            const ps = pageSizeDefault();
            const total = currentView.length;
            const pages = Math.max(1, Math.ceil(total / ps));
            if (currentPage > pages) currentPage = pages;
            const start = (currentPage - 1) * ps; const end = Math.min(total, start + ps);
            const slice = currentView.slice(start, end);
            tbody.innerHTML = slice.map(r => `<tr>${cols.map(c => `<td>${r[c] ?? ''}</td>`).join('')}</tr>`).join('');
            showingCount.textContent = `${start + 1}-${end} of ${formatNumber(total)}`;
            renderPaginationControls(pages);
        }

        function renderPaginationControls(totalPages) {
            pagination.innerHTML = '';

            const makeLi = (label, disabled, active, action) => {
                const li = document.createElement('li');
                li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.innerHTML = label;
                if (!disabled && action) a.onclick = (e) => { e.preventDefault(); action(); };
                li.appendChild(a);
                return li;
            };

            pagination.appendChild(makeLi('&laquo;', currentPage === 1, false, () => { currentPage = 1; renderTable(); }));
            pagination.appendChild(makeLi('&lt;', currentPage === 1, false, () => { if (currentPage > 1) currentPage--; renderTable(); }));

            // show sliding window of pages (2 pages left/right)
            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);
            for (let p = start; p <= end; p++) {
                pagination.appendChild(makeLi(String(p), false, p === currentPage, () => { currentPage = p; renderTable(); }));
            }

            pagination.appendChild(makeLi('&gt;', currentPage === totalPages, false, () => { if (currentPage < totalPages) currentPage++; renderTable(); }));
            pagination.appendChild(makeLi('&raquo;', currentPage === totalPages, false, () => { currentPage = totalPages; renderTable(); }));
        }

        function renderChart() {
            const canvas = document.getElementById('chartCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext && canvas.getContext('2d');
            if (!ctx) return;
            if (chart) chart.destroy();
            if (!currentView.length) return;
            const cols = Object.keys(currentView[0] || {});
            const x = cols[0]; const y = cols[1] || cols[0];
            const labels = currentView.map(r => r[x]);
            const data = currentView.map(r => parseFloat(String(r[y]).replace(/,/g, '')) || 0);
            try {
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: y, data }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { autoSkip: true } } } }
                });
            } catch (e) {
                console.warn('Chart render failed', e);
            }
        }

        // --- File handling ---
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        if (file.name.toLowerCase().endsWith('.json')) {
                            const txt = new TextDecoder().decode(e.target.result);
                            resolve(JSON.parse(txt));
                        } else {
                            // use array buffer for XLSX
                            const data = new Uint8Array(e.target.result);
                            const wb = XLSX.read(data, { type: 'array' });
                            const sheet = wb.Sheets[wb.SheetNames[0]];
                            const dataArr = XLSX.utils.sheet_to_json(sheet, { defval: null });
                            resolve(dataArr);
                        }
                    } catch (err) { reject(err); }
                };
                reader.onerror = (ev) => reject(new Error('File read error'));
                if (file.name.toLowerCase().endsWith('.json')) reader.readAsArrayBuffer(file); else reader.readAsArrayBuffer(file);
            });
        }

        async function handleFile(file) {
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { alert('Max 10 MB allowed'); return; }
            uploader.classList.remove('dragover');
            try {
                const data = await readFile(file);
                if (!Array.isArray(data)) throw new Error('Unsupported JSON structure — expected array of objects.');
                fullData = data.map((r, i) => ({ ...r, _row_index: i + 1 }));
                filteredData = [...fullData];
                currentView = [...fullData];
                // Populate UI
                const cols = Object.keys(fullData[0] || {});
                rowCount.textContent = formatNumber(fullData.length) + ' rows';
                colCount.textContent = cols.length + ' columns';
                const types = cols.map(c => `${c}: ${detectType(fullData.map(r => r[c]))}`);
                schemaSummary.textContent = types.slice(0, 6).join(' • ') || 'No columns';
                populateColumnsUI(cols);
                renderTable(); renderChart();
            } catch (err) { alert('Failed to load file: ' + (err && err.message ? err.message : err)); }
        }

        // uploader click + drag/drop
        // input now covers uploader area; loadBtn opens picker too
        uploader.addEventListener('dragover', e => { e.preventDefault(); uploader.classList.add('dragover'); });
        uploader.addEventListener('dragleave', e => { e.preventDefault(); uploader.classList.remove('dragover'); });
        uploader.addEventListener('drop', e => {
            e.preventDefault();
            uploader.classList.remove('dragover');
            const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (f) handleFile(f);
        });
        fileInput.onchange = (e) => handleFile(e.target.files[0]);
        loadBtn.onclick = () => fileInput.click();

        // --- Search debounce ---
        let searchTimer = null;
        globalSearch.addEventListener('input', () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                const q = globalSearch.value.trim().toLowerCase();
                if (!q) { currentView = [...filteredData]; renderTable(); renderChart(); return; }
                const cols = Object.keys(filteredData[0] || {});
                currentView = filteredData.filter(r => cols.some(c => String(r[c] || '').toLowerCase().includes(q)));
                currentPage = 1; renderTable(); renderChart();
            }, 300);
        });

        // --- Exports ---
        function exportData(format = 'xlsx') {
            try {
                const ws = XLSX.utils.json_to_sheet(filteredData || []);
                if (format === 'csv') {
                    const csv = XLSX.utils.sheet_to_csv(ws);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'datalens_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                } else {
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Results');
                    XLSX.writeFile(wb, `datalens_export.xlsx`);
                }
            } catch (e) {
                alert('Export failed: ' + e.message);
            }
        }
        document.getElementById('exportCSVBtn').onclick = () => exportData('csv');
        document.getElementById('exportExcelBtn').onclick = () => exportData('xlsx');
        document.getElementById('downloadViewBtn').onclick = () => {
            try {
                const ws = XLSX.utils.json_to_sheet(currentView || []);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'View'); XLSX.writeFile(wb, 'datalens_view.xlsx');
            } catch (e) { alert('Download failed: ' + e.message); }
        }

        // copy to clipboard
        document.getElementById('copyBtn').onclick = async () => {
            const rows = Array.from(dataTable.querySelectorAll('tr')).map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => td.innerText).join('\t')).join('\n');
            try { await navigator.clipboard.writeText(rows); alert('Table copied to clipboard'); } catch (e) { alert('Copy failed'); }
        }

        // clear filters
        document.getElementById('clearFilters').onclick = () => { filterContainer.innerHTML = ''; }

        // page size change
        pageSizeSel.onchange = () => renderTable();

        // reset query
        document.getElementById('resetQueryBtn').onclick = () => {
            // reselect all columns
            Array.from(columnsContainer.querySelectorAll('input[type=checkbox]')).forEach(c => c.checked = true);
            filterContainer.innerHTML = '';
            orderContainer.innerHTML = '';
            groupBySelect.value = '';
            aggFuncSelect.value = '';
            aggFieldSelect.value = '';
            globalSearch.value = '';
            filteredData = [...fullData]; currentView = [...fullData]; currentPage = 1; renderTable(); renderChart();
        }

        // initial placeholder
        renderTable();

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/app.js"></script>
</body>

</html>